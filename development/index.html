<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Map from styles</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
          margin: 0;
          padding: 0;
        }

        /**
        * Create a position for the map
        * on the page */
        #map {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 100%;
        }

        /**
        * Set rules for how the map overlays
        * (information box and legend) will be displayed
        * on the page. */
        .map-overlay {
          position: absolute;
          top: 0;
          left: 0;
          background: rgba(255, 255, 255, 0.8);
          margin-right: 20px;
          font-family: Arial, sans-serif;
          overflow: auto;
          border-radius: 3px;
        }

    </style>
</head>
<body>

<div id='map'></div>
<div class='map-overlay' id='ttip'>
    <h2>Concejales Elecciones municipales 2019</h2>
    <div id='pd'>
        <p>Hover over a state!</p>
    </div>
</div>


<script>

  // - - - REFERENCES:
  // - Highlight selected
  //   https://docs.mapbox.com/mapbox-gl-js/example/hover-styles/
  // - Highlight related & add source & add layer
  //   https://blog.mapbox.com/going-live-with-electoral-maps-a-guide-to-feature-state-b520e91a22d


  // - - - INITIALIZE A MAP
  mapboxgl.accessToken = 'pk.eyJ1IjoidmlzdWFsaXphZG9zIiwiYSI6ImNqd2kxN25ndTAzOTg0M3BoYjhjM29iMXAifQ.OnzqLMA0qPRZ6E_ybCbzlw';

  // location_id as id
  const dots_u = 'mapbox://visualizados.8fxl1q6e',
      dots_sl = 'seats',
      muni_u = 'mapbox://visualizados.04y4fix9',
      muni_sl = 'municipalities',
      lonlat = [-3.8196207, 40.4378698];

  // // standard
  // var dots_u = 'mapbox://visualizados.ckln4vzd',
  //     dots_sl = 'seats',
  //     muni_u = 'mapbox://visualizados.3egf3d1o',
  //     muni_sl = 'municipalities',
  //     lonlat = [-3.8196207, 40.4378698];

  // Create a map
  const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/visualizados/cjxddrpkt00p51cogpkv53w7l',
      zoom: 10,
      center: lonlat
  });

  // Create a popup, but don't add it to the map yet.
  var popup = new mapboxgl.Popup({
    closeButton: false
  });

  // Create a var to store the hovered feature
  let hoveredMuniId =  null;


  map.on('load', function(m) {
    // - - - ADD THE SOURCES
    // In this case is better to add sources beforehand, 
    // beacause they will be used more than once.
    map.addSource("municipalities", {
      type: 'vector',
      url: muni_u
    });

    map.addSource("dots", {
      type: 'vector',
      url: dots_u
    });


    // - - - ADD THE LAYERS
    map.addLayer({
      "id": "municipalities-fills", // whatever
      "type": "fill", // type of geometry
      'source': 'municipalities', // added source or object `{type: , url: }`
      "source-layer": muni_sl, 
      "layout": {},
      "paint": {
        "fill-outline-color": "rgb(220,220,220)",
        "fill-color": "rgb(220,220,220)",
        "fill-opacity": ["case",
          ["boolean", ["feature-state", "hover"], false],
          0,
          0.7 // hover false
        ]
      }
    }, 'settlement-label'); // Place polygon under these labels.

    map.addLayer({
      "id": "dots",
      'type': 'circle',
      'source': 'dots',
      "source-layer": dots_sl, //https://docs.mapbox.com/help/glossary/source-layer/
      'paint': {
          'circle-radius': {
            'base': 1,
            'stops': [[6, 1.5], [8, 2.5], [12, 4], [16, 20]]
          },
          "circle-opacity": ["case",
            ["boolean", ["feature-state", "hover"], false],
            1,
            0.3 // hover false
          ],
          "circle-color": ["get", "color_hex"]
      }
    }, 'settlement-label'); 

    map.addLayer({
      "id": "dots-all-overlay",
      'type': 'circle',
      'source': 'dots',
      "source-layer": dots_sl,
      'paint': {
         'circle-radius': {
            'base': 1,
            'stops': [[6, 1.5], [8, 2.5], [12, 4], [16, 20]]
          },
          "circle-opacity": 1,
          "circle-color": ["get", "color_hex"]
      }
    }, 'settlement-label'); 

    // - - - INTERACTION
    map.on('mousemove', 'municipalities-fills', function(e) { // event, layer, callback

      // - - - SHOW POPUP - - - //

      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      // Single out the first found feature.
      var feature = e.features[0];

      // Display a popup with the name of the county
      popup.setLngLat(e.lngLat)
          .setText(feature.properties.muni_name)
          .addTo(map);


      // - - - HIGHLIGHT SELECTED & RELATED- - - //
      if (feature !== undefined) {
        // Each municipality should have its own and unique id, although is splitted into multiple tiles.
        
        // - - Remove last interaction
        if (hoveredMuniId) {
          map.setFeatureState({
            source: 'municipalities',
            sourceLayer: muni_sl,
            id: hoveredMuniId},
            {hover: false}
          );
        
          map.setFeatureState({
            source: 'dots',
            sourceLayer: dots_sl,
            id: hoveredMuniId},
            {hover: false}
          );
        }

        // - - Add new interaction
        hoveredMuniId = feature.id;
        
        map.setFeatureState({
          source: 'municipalities',
          sourceLayer: muni_sl,
          id: hoveredMuniId},
          {hover: true}
        );
        
        // Un-highlight overlay dots
        map.setPaintProperty('dots-all-overlay', 'circle-opacity', 0);

        map.setFeatureState({
          source: 'dots',
          sourceLayer: dots_sl,
          id: hoveredMuniId},
          {hover: true}
        );

        // TODO::Display a div con los datos del municipio
        // concejales por partido
        // rayita con la mayoría absoluta
        // le paso la feature ID a una clase que pintará el gráfico
        // y actualizará los textos: 
        // Nombre del municipio
        // Número de concejales
        // Gráfico
        // Leyenda (colorscale común a todos, o hacer un subset de los colores o algo)

      }

    }); // end mousemove

    map.on("mouseleave", "municipalities-fills", function() {
      
      // - - - HIDE POPUP - - - //
      map.getCanvas().style.cursor = '';
      popup.remove();

      // - - - RESTORE SEATS - - - //
      map.setPaintProperty('dots-all-overlay', 'circle-opacity', 1);

      // - - - RESTORE SELECTED - - - //
      if (hoveredMuniId) {
        map.setFeatureState({
          source: 'municipalities',
          sourceLayer: muni_sl,
          id: hoveredMuniId},
          {hover: false}
        );
        map.setFeatureState({
          source: 'dots',
          sourceLayer: dots_sl,
          id: hoveredMuniId},
          {hover: false}
        );
      }
      hoveredMuniId =  null;
    
    }); // end mouseleave
  }); // end map on load

    

</script>

</body>
</html>