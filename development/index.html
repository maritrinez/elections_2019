<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Map from styles</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet'/>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.1/mapbox-gl-geocoder.css' type='text/css'/>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <style>
        body {
          margin: 0;
          padding: 0;
        }

        /**
        * Create a position for the map
        * on the page */
        #map {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 100%;
        }

        /**
        * Set rules for how the map overlays
        * (information box and legend) will be displayed
        * on the page. */
        .map-overlay {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          background: rgba(255, 255, 255, 0.8);
          margin-right: 20px;
          font-family: Arial, sans-serif;
          overflow: auto;
          border-radius: 3px;
        }

        path, line {
          stroke: none;
        }

    </style>
</head>
<body>

<div id='map'></div>
<div class='map-overlay'>
    <h2>Elecciones municipales 2019</h2>
    <h3>Mapa de concejales</h3>
    <div id='ttip'>
        <h3>España</h3>
        <h4>66.418 concejales</h4>
        <svg class='chart'></svg>
    </div>
</div>


<script>

  // - - - REFERENCES:
  // - Highlight selected
  //   https://docs.mapbox.com/mapbox-gl-js/example/hover-styles/
  // - Highlight related & add source & add layer
  //   https://blog.mapbox.com/going-live-with-electoral-maps-a-guide-to-feature-state-b520e91a22d


  // - - - RENDER DEFAULT TOOLTIP
  defaultTooltip();

  // - - - INITIALIZE A MAP
  mapboxgl.accessToken = 'pk.eyJ1IjoidmlzdWFsaXphZG9zIiwiYSI6ImNqd2kxN25ndTAzOTg0M3BoYjhjM29iMXAifQ.OnzqLMA0qPRZ6E_ybCbzlw';

  // location_id as id
  const dots_u = 'mapbox://visualizados.8fxl1q6e',
      dots_sl = 'seats',
      muni_u = 'mapbox://visualizados.04y4fix9',
      muni_sl = 'municipalities',
      lonlat = [-3.8196207, 40.4378698];

  // // standard
  // var dots_u = 'mapbox://visualizados.ckln4vzd',
  //     dots_sl = 'seats',
  //     muni_u = 'mapbox://visualizados.3egf3d1o',
  //     muni_sl = 'municipalities',
  //     lonlat = [-3.8196207, 40.4378698];

  // Create a map
  const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/visualizados/cjxddrpkt00p51cogpkv53w7l',
      zoom: 5,
      center: lonlat
  });

  map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl: mapboxgl
  }));

  // Create a var to store the hovered feature
  let hoveredMuniId =  null;


  map.on('load', function(m) {
    // - - - ADD THE SOURCES
    // In this case is better to add sources beforehand, 
    // beacause they will be used more than once.
    map.addSource("municipalities", {
      type: 'vector',
      url: muni_u
    });

    map.addSource("dots", {
      type: 'vector',
      url: dots_u
    });


    // - - - ADD THE LAYERS
    map.addLayer({
      "id": "municipalities-fills", // whatever
      "type": "fill", // type of geometry
      'source': 'municipalities', // added source or object `{type: , url: }`
      "source-layer": muni_sl, 
      "layout": {},
      "paint": {
        "fill-outline-color": "rgb(220,220,220)",
        "fill-color": "rgb(220,220,220)",
        "fill-opacity": ["case",
          ["boolean", ["feature-state", "hover"], false],
          0,
          0.7 // hover false
        ]
      }
    }, 'settlement-label'); // Place polygon under these labels.

    map.addLayer({
      "id": "dots",
      'type': 'circle',
      'source': 'dots',
      "source-layer": dots_sl, //https://docs.mapbox.com/help/glossary/source-layer/
      'paint': {
          'circle-radius': {
            'base': 1,
            'stops': [[6, 1.5], [8, 2.5], [12, 4], [16, 20]]
          },
          "circle-opacity": ["case",
            ["boolean", ["feature-state", "hover"], false],
            1,
            0.1 // hover false
          ],
          "circle-color": ["get", "color_hex"]
      }
    }, 'settlement-label'); 

    map.addLayer({
      "id": "dots-all-overlay",
      'type': 'circle',
      'source': 'dots',
      "source-layer": dots_sl,
      'paint': {
         'circle-radius': {
            'base': 1,
            'stops': [[6, 1.5], [8, 2.5], [12, 4], [16, 20]]
          },
          "circle-opacity": 0.5,
          "circle-color": ["get", "color_hex"]
      }
    }, 'settlement-label'); 

    // - - - INTERACTION
    map.on('mousemove', 'municipalities-fills', function(e) { // event, layer, callback

      // - - - GET FEATURE - - - //

      // Change the cursor style as a UI indicator.
      map.getCanvas().style.cursor = 'pointer';

      // Single out the first found feature.
      var feature = e.features[0];

      // - - - HIGHLIGHT SELECTED & RELATED- - - //
      if (feature !== undefined) {
        // Each municipality should have its own and unique id, although is splitted into multiple tiles.
        
        // - - Remove last interaction
        if (hoveredMuniId) {
          map.setFeatureState({
            source: 'municipalities',
            sourceLayer: muni_sl,
            id: hoveredMuniId},
            {hover: false}
          );
        
          map.setFeatureState({
            source: 'dots',
            sourceLayer: dots_sl,
            id: hoveredMuniId},
            {hover: false}
          );
        }

        // - - Add new interaction
        hoveredMuniId = feature.id;
        
        map.setFeatureState({
          source: 'municipalities',
          sourceLayer: muni_sl,
          id: hoveredMuniId},
          {hover: true}
        );
        
        // Un-highlight overlay dots
        map.setPaintProperty('dots-all-overlay', 'circle-opacity', 0);

        map.setFeatureState({
          source: 'dots',
          sourceLayer: dots_sl,
          id: hoveredMuniId},
          {hover: true}
        );

        // TODO::Display a div con los datos del municipio
        // concejales por partido
        // rayita con la mayoría absoluta
        // le paso la feature ID a una clase que pintará el gráfico
        // y actualizará los textos: 
        // Nombre del municipio
        // Número de concejales
        // Gráfico
        // Leyenda (colorscale común a todos, o hacer un subset de los colores o algo)
        updateTooltip(feature.properties)
      }

    }); // end mousemove

    map.on("mouseleave", "municipalities-fills", function() {
      map.getCanvas().style.cursor = '';

      // - - - RESTORE SEATS - - - //
      map.setPaintProperty('dots-all-overlay', 'circle-opacity', 1);

      // - - - RESTORE SELECTED - - - //
      if (hoveredMuniId) {
        map.setFeatureState({
          source: 'municipalities',
          sourceLayer: muni_sl,
          id: hoveredMuniId},
          {hover: false}
        );
        map.setFeatureState({
          source: 'dots',
          sourceLayer: dots_sl,
          id: hoveredMuniId},
          {hover: false}
        );
      }
      hoveredMuniId =  null;
      defaultTooltip();
    
    }); // end mouseleave
  }); // end map on load
  
  function updateTooltip (d) {
    console.log(d);

    d3.select('#ttip')
      .html(`<h2>${d.muni_name} (provincia)</h2><p>${d.seats_given} concejales</p>`)
  }

  function defaultTooltip () {
    
    d3.select('#ttip')
      .html(
        `<h3>España</h3>
        <h4>66.418 concejales</h4>
        <svg class='chart'></svg>`
      );

    d3.csv("data/top10parties.csv", d => {
      d.seats = +d.seats
      return d
    }).then(barchart); 


    function barchart(data) {
      console.log(data)
      const w = 300,
            h = 500,
            p = 30;

      const yScl = d3.scaleBand()
        .domain(data.map(d => d.p_acronym))
        .range([0, h - p * 2])
        .padding(0.5);

      const xScl = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.seats)])
        .range([0, w - p * 2]);

      const svg = d3.select('#ttip').select('svg.chart')
        .attr('width', w)
        .attr('height', h)
        .append('g')
        .attr('transform', `translate(${p}, ${p})`);
      
      svg.selectAll('rect')
        .data(data)
        .enter()
        .append('rect')
          .attr('x', 0)
          .attr('y', d => yScl(d.p_acronym))
          .attr('width', d => xScl(d.seats))
          .attr('height', yScl.bandwidth())
          .style('fill', d => d.color_hex);

      svg.append('g')
        .attr('transform', `translate(${9}, ${-yScl.bandwidth()/2 - 5})`)
        .call(d3.axisLeft(yScl))
        .selectAll('text')
        .attr('text-anchor', 'start')

    }
  }
    

</script>

</body>
</html>